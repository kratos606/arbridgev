import{a as B,u as L,r,j as a}from"./index-Dit8z4pW.js";import{T as S,S as T,P as M,M as C,D as G,a as N,G as U}from"./model-viewer-BMtXc3mG.js";function F(){const{image:i}=B(),h=L(),u=r.useRef(null),m=r.useRef(null),p=r.useRef(null),[w,g]=r.useState(""),[y,b]=r.useState(!1);r.useEffect(()=>{/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)||h(`/poster/${i}`)},[i,h]),r.useEffect(()=>{u.current&&u.current.setAttribute("data-ar-status","pending")},[]),r.useEffect(()=>{async function t(){b(!0);try{const s=await(await fetch(`https://ardisplay.ddns.net:3000/check-model/${i}.glb`)).json();if(s.exists)g("https://ardisplay.ddns.net:3000"+s.url);else{const n=`/images/${i}`,e=await x(n),l=await R(e),d=await k(l,`${i}.glb`);g(d.url)}}catch(o){console.error("Error processing image:",o)}finally{b(!1)}}t()},[i]);function x(t){return new Promise((o,s)=>{new S().load(t,e=>{o(e)},void 0,e=>{s(e)})})}function R(t){return new Promise((o,s)=>{const n=new T,e=t.image.width/t.image.height,l=1,d=l*e,f=new M(d,l),P=new C({map:t,side:G,transparent:!0}),A=new N(f,P);n.add(A),new U().parse(n,c=>{const E=c instanceof ArrayBuffer?c:new Uint8Array(c);o(E)},c=>{console.error("An error occurred during GLTF export:",c),s(c)},{binary:!0})})}async function k(t,o){const s=new FormData,n=new Blob([t],{type:"application/octet-stream"});s.append("model",n,o);try{const e=await fetch("https://ardisplay.ddns.net:3000/upload",{method:"POST",body:s,headers:{Accept:"application/json"}});if(!e.ok){const f=await e.text();throw new Error(`HTTP error! status: ${e.status}, message: ${f}`)}return{url:"https://ardisplay.ddns.net:3000"+`${(await e.json()).url}`}}catch(e){throw console.error("Upload error:",e),new Error("Failed to upload GLB model: "+e.message)}}const v=()=>{p.current&&p.current.click()},j=()=>{m.current&&m.current.resetCamera()};return a.jsxs("div",{className:"h-screen overflow-hidden bg-[#f8f8f8]","data-ar-status":"pending",ref:u,children:[a.jsxs("model-viewer",{ref:m,src:w,ar:!0,"ar-modes":"webxr scene-viewer quick-look","camera-controls":!0,"environment-image":"/brown_photostudio_02_1k.hdr","skybox-image":"/brown_photostudio_02_1k.hdr","shadow-intensity":"1","shadow-softness":"1",exposure:"1","auto-rotate":!0,"interaction-prompt":"auto","auto-rotate-delay":"0","rotation-per-second":"30deg","field-of-view":"30deg","min-camera-orbit":"auto auto auto","max-camera-orbit":"auto auto auto","min-field-of-view":"10deg","max-field-of-view":"45deg",bounds:"tight","ar-placement":"wall","placement-mode":"automatic","shadow-root-opacity":"0.8","environment-intensity":"1","tone-mapping":"commerce",style:{width:"100%",height:"100%"},onARStatus:t=>{t.detail.status==="failed"?document.getElementById("error").style.display="block":document.getElementById("error").style.display="none"},children:[a.jsx("div",{className:"progress-bar",slot:"progress-bar",children:a.jsx("div",{className:"update-bar"})}),a.jsx("button",{slot:"ar-button",ref:p,className:"ar-button",disabled:!w||y,onClick:v,children:"AR View"})]}),a.jsx("div",{className:"controls",children:a.jsx("button",{onClick:j,children:"Reset"})}),a.jsx("div",{className:"absolute top-0 left-0 right-0 bottom-0 z-50 bg-white text-black h-full w-full hidden",id:"error",children:" Can't display AR "})]})}export{F as default};
